#!/bin/bash

VERSION="1.1.1"

# Colors
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

# Flags
USER_ONLY=false

show_help() {
  echo "Usage: ports [options]"
  echo ""
  echo "Show listening ports with process info"
  echo ""
  echo "Options:"
  echo "  -u, --user     Show only user-started processes (with project path)"
  echo "  -h, --help     Show this help message"
  echo "  -v, --version  Show version"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      exit 0
      ;;
    -v|--version)
      echo "ports $VERSION"
      exit 0
      ;;
    -u|--user)
      USER_ONLY=true
      shift
      ;;
    *)
      echo "Unknown option: $1"
      show_help
      exit 1
      ;;
  esac
done

# Header
printf "${BOLD}%-8s %-24s %s${RESET}\n" "PORT" "PROCESS" "PATH"
printf "${DIM}%-8s %-24s %s${RESET}\n" "----" "-------" "----"

# Track seen ports to avoid duplicates
declare -A seen_ports

# Get listening ports using process substitution to avoid subshell
while read line; do
  [[ -z "$line" ]] && continue
  
  proc=$(echo "$line" | awk '{print $1}')
  pid=$(echo "$line" | awk '{print $2}')
  port=$(echo "$line" | awk '{print $9}' | sed 's/.*://')

  # Skip if we've already seen this port
  [[ -n "${seen_ports[$port]}" ]] && continue
  seen_ports[$port]=1

  display_path="-"

  # For Node processes, try to get project name from package.json
  if [ "$proc" = "node" ]; then
    cwd=$(lsof -p "$pid" 2>/dev/null | grep cwd | awk '{print $9}')
    if [ -f "$cwd/package.json" ]; then
      name=$(grep '"name"' "$cwd/package.json" | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')
      if [ -n "$name" ]; then
        proc="$name"
      fi
    fi
    # Shorten home directory path
    display_path=$(echo "$cwd" | sed "s|$HOME|~|")
  fi

  # Filter for user-only mode
  if [ "$USER_ONLY" = true ]; then
    [ "$display_path" = "-" ] && continue
    [ -z "$display_path" ] && continue
  fi

  printf "%-8s %-24s %s\n" "$port" "$proc" "$display_path"
done < <(lsof -iTCP -sTCP:LISTEN -n -P 2>/dev/null | grep -v "^COMMAND")
